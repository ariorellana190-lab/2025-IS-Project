<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Snake — HTML5 Canvas (Corregido)</title>
  <style>
    :root{
      --bg:#071021;
      --panel:rgba(255,255,255,0.03);
      --accent:#10b981;
      --muted:#94a3b8;
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
    body{display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#071021,#04101a);color:#e6eef8;padding:20px}
    .app{width:960px;max-width:100%;display:grid;grid-template-columns:2fr 1fr;gap:18px}
    .card{background:var(--panel);border-radius:12px;padding:16px;box-shadow:0 6px 20px rgba(2,6,23,0.6)}
    h1{margin:0 0 12px;font-size:20px}
    .canvas-wrap{border-radius:8px;overflow:hidden;border:1px solid rgba(255,255,255,0.03)}
    canvas{display:block;width:100%;height:auto;background:#071026;touch-action:none}
    .controls{display:flex;gap:8px;margin-top:12px;align-items:center}
    button{background:var(--accent);border:none;padding:8px 12px;border-radius:8px;color:#042018;font-weight:600;cursor:pointer}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .sidebar{display:flex;flex-direction:column;gap:12px}
    label{font-size:13px;color:var(--muted)}
    input[type=range]{width:100%}
    .small{font-size:13px;color:var(--muted)}
    .bigScore{font-size:28px;color:var(--accent);font-weight:700}
    .muted{color:var(--muted)}
    .overlay{position:absolute;left:0;top:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;pointer-events:none}
    .overlay .box{background:rgba(2,6,23,0.8);padding:16px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);pointer-events:auto}
    @media(max-width:900px){.app{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="app">
    <div class="card" style="position:relative">
      <h1>Snake — HTML5 Canvas (Corregido)</h1>
      <div class="canvas-wrap">
        <canvas id="game" width="640" height="640"></canvas>
      </div>

      <div class="controls">
        <button id="start">Start</button>
        <button id="pause" class="ghost">Pause</button>
        <button id="reset" class="ghost">Reset</button>
        <div style="margin-left:auto" class="small muted">Flechas o WASD • Espacio = play/pause</div>
      </div>

      <!-- overlay para mensajes (Game Over, Pausa) -->
      <div id="overlay" class="overlay" style="display:none">
        <div class="box" id="overlayBox">
          <div id="overlayText" style="font-weight:700;font-size:18px;margin-bottom:8px">Game Over</div>
          <div id="overlaySub" class="small muted">Score: 0</div>
          <div style="margin-top:10px;text-align:right">
            <button id="overlayClose" class="ghost">Cerrar</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card sidebar">
      <div>
        <div class="small muted">Score</div>
        <div class="bigScore" id="score">0</div>
      </div>

      <div>
        <label class="small muted">Velocidad (<span id="speedVal">8</span>)</label>
        <input id="speed" type="range" min="4" max="20" value="8">
      </div>

      <div>
        <div class="small muted">Opciones</div>
        <div class="small">Wrap walls: <input id="wrap" type="checkbox"></div>
      </div>

      <div>
        <div class="small muted">Cómo jugar</div>
        <div class="small">Come la casilla roja para crecer. No choques contra las paredes (si wrap está desactivado) ni contra tu propio cuerpo.</div>
      </div>
    </div>
  </div>

  <script>
  (function(){
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const GRID = 20;            // celdas por fila/columna
    let CELL = 32;              // px por celda en diseño (se recalcula con DPR)
    let dpr = Math.max(1, window.devicePixelRatio || 1);

    // estado
    let snake = [{x:10,y:10}];
    let dir = {x:1,y:0};
    let food = {x:15,y:10};
    let running = false;
    let speed = 8; // movimientos por segundo
    let score = 0;
    let wrap = false;
    let timerId = null;
    let gameOver = false;

    // UI
    const scoreEl = document.getElementById('score');
    const speedValEl = document.getElementById('speedVal');
    const overlay = document.getElementById('overlay');
    const overlayText = document.getElementById('overlayText');
    const overlaySub = document.getElementById('overlaySub');
    const overlayClose = document.getElementById('overlayClose');

    // ajustar canvas para devicePixelRatio y tamaño responsivo
    function fitCanvas(){
      // anchura del contenedor (.canvas-wrap width)
      const wrap = canvas.parentElement;
      const cssWidth = wrap.clientWidth;
      // fijamos canvas CSS width 100% (en CSS) y ahora ajustamos su pixel backing store
      const size = Math.min(cssWidth, 640); // limitar a 640 diseño
      canvas.style.width = size + 'px';
      canvas.style.height = size + 'px';
      const backing = Math.floor(size * dpr);
      canvas.width = backing;
      canvas.height = backing;
      CELL = backing / GRID;
    }

    window.addEventListener('resize', ()=>{ fitCanvas(); draw(); });

    // util
    function randPos(){
      return { x: Math.floor(Math.random()*GRID), y: Math.floor(Math.random()*GRID) };
    }
    function posEqual(a,b){ return a.x===b.x && a.y===b.y; }

    function placeFood(){
      const taken = new Set(snake.map(s=>s.x+':'+s.y));
      let p;
      do { p = randPos(); } while (taken.has(p.x+':'+p.y));
      food = p;
    }

    function clearScreen(){
      ctx.fillStyle = '#071026';
      ctx.fillRect(0,0,canvas.width,canvas.height);
    }

    function drawGrid(){
      ctx.strokeStyle = 'rgba(255,255,255,0.03)';
      ctx.lineWidth = Math.max(1, dpr*0.3);
      for(let i=0;i<=GRID;i++){
        const x = i * CELL;
        ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,canvas.height); ctx.stroke();
        const y = i * CELL;
        ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); ctx.stroke();
      }
    }

    function draw(){
      clearScreen();
      drawGrid();

      // food
      ctx.fillStyle = '#ef4444';
      ctx.fillRect(Math.round(food.x*CELL+2*dpr), Math.round(food.y*CELL+2*dpr), Math.round(CELL-4*dpr), Math.round(CELL-4*dpr));

      // snake
      snake.forEach((s,i)=>{
        ctx.fillStyle = i===0 ? '#10b981' : '#34d399';
        ctx.fillRect(Math.round(s.x*CELL+1*dpr), Math.round(s.y*CELL+1*dpr), Math.round(CELL-2*dpr), Math.round(CELL-2*dpr));
      });
    }

    function step(){
      if(!running) return;
      const newHead = { x: snake[0].x + dir.x, y: snake[0].y + dir.y };

      if(wrap){
        newHead.x = (newHead.x + GRID) % GRID;
        newHead.y = (newHead.y + GRID) % GRID;
      } else {
        if(newHead.x < 0 || newHead.x >= GRID || newHead.y < 0 || newHead.y >= GRID){
          endGame();
          return;
        }
      }

      if(snake.some(s => posEqual(s, newHead))){
        endGame();
        return;
      }

      const ate = posEqual(newHead, food);
      snake.unshift(newHead);
      if(!ate) snake.pop();
      else {
        score++;
        scoreEl.textContent = score;
        placeFood();
      }
      draw();
    }

    function loop(){
      if(timerId) clearInterval(timerId);
      timerId = setInterval(step, Math.round(1000 / speed));
    }

    function start(){
      if(gameOver){
        // reiniciar si ya hubo Game Over
        resetState();
      }
      if(running) return;
      running = true;
      loop();
      hideOverlay();
    }

    function pause(){
      running = false;
      if(timerId){ clearInterval(timerId); timerId = null; }
      showOverlay('Paused', 'Pulsa Start para continuar');
    }

    function resetState(){
      running = false;
      gameOver = false;
      snake = [{x:Math.floor(GRID/2), y:Math.floor(GRID/2)}];
      dir = {x:1,y:0};
      score = 0; scoreEl.textContent = score;
      placeFood();
      if(timerId){ clearInterval(timerId); timerId = null; }
      hideOverlay();
      draw();
    }

    function endGame(){
      running = false;
      gameOver = true;
      if(timerId){ clearInterval(timerId); timerId = null; }
      showOverlay('Game Over', 'Score: ' + score);
    }

    function showOverlay(title, sub){
      overlayText.textContent = title;
      overlaySub.textContent = sub;
      overlay.style.display = 'flex';
    }
    function hideOverlay(){ overlay.style.display = 'none'; }

    // controles teclado
    window.addEventListener('keydown', e=>{
      const k = e.key;
      if((k==='ArrowUp'||k==='w') && dir.y!==1) dir = {x:0,y:-1};
      if((k==='ArrowDown'||k==='s') && dir.y!==-1) dir = {x:0,y:1};
      if((k==='ArrowLeft'||k==='a') && dir.x!==1) dir = {x:-1,y:0};
      if((k==='ArrowRight'||k==='d') && dir.x!==-1) dir = {x:1,y:0};
      if(k===' '){ if(running) pause(); else start(); }
    });

    // swipe para móvil
    (function(){
      let sx=0, sy=0, threshold=20;
      canvas.addEventListener('touchstart', e=>{ const t=e.touches[0]; sx=t.clientX; sy=t.clientY; });
      canvas.addEventListener('touchend', e=>{
        const t = e.changedTouches[0]; const dx = t.clientX - sx, dy = t.clientY - sy;
        if(Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > threshold){
          if(dx > 0 && dir.x!==-1) dir = {x:1,y:0};
          else if(dx < 0 && dir.x!==1) dir = {x:-1,y:0};
        } else if(Math.abs(dy) > threshold){
          if(dy > 0 && dir.y!==-1) dir = {x:0,y:1};
          else if(dy < 0 && dir.y!==1) dir = {x:0,y:-1};
        }
      });
    })();

    // UI bindings
    document.getElementById('start').addEventListener('click', start);
    document.getElementById('pause').addEventListener('click', ()=>{ if(running) pause(); else start(); });
    document.getElementById('reset').addEventListener('click', resetState);
    document.getElementById('speed').addEventListener('input', (e)=>{ speed = Number(e.target.value); speedValEl.textContent = speed; if(running) loop(); });
    document.getElementById('wrap').addEventListener('change', (e)=>{ wrap = e.target.checked; });
    overlayClose.addEventListener('click', ()=>{ hideOverlay(); });

    // inicialización
    fitCanvas();
    placeFood();
    draw();

  })();
  </script>
</body>
</html>
